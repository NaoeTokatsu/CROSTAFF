<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CROSTAFF QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #007b43;
      color: white;
      font-family: 'Noto Sans', sans-serif;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #007b43;
      padding: 10px 20px;
      font-weight: 900;
      font-size: 2.2em;
    }
    #info {
      background: #007b43;
      padding: 0 30px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.3em;
      font-weight: bold;
    }
    #area-name, #status {
      font-size: 1.2em;
    }
    #reader-container {
      position: relative;
      width: 100vw;
      height: calc(100vh - 170px);
    }
    #reader {
      width: 100vw;
      height: 100%;
      object-fit: cover;
      background: #000;
      position: relative;
      z-index: 1;
    }
    /* QRスキャン範囲を画面中央より少し上に正方形で配置 */
    .qr-custom-overlay {
      position: absolute;
      left: 50%;
      top: 32%;
      transform: translate(-50%, -50%);
      border: 4px solid #fff;
      border-radius: 18px;
      width: min(60vw, 360px);
      height: min(60vw, 360px);
      box-shadow: 0 0 16px 4px rgba(0,0,0,0.25);
      z-index: 4;
      pointer-events: none;
    }
    #result-banner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      color: white;
      font-size: 2.4em;
      font-weight: bold;
      padding: 36px 32px;
      border-radius: 18px;
      text-align: center;
      z-index: 20;
      display: none;
      min-width: 240px;
      white-space: pre-line;
      letter-spacing: 0.03em;
      box-shadow: 0 0 18px 6px rgba(0,0,0,0.4);
    }
    #processing-banner {
      display: none;
      position: fixed;
      left: 0; right: 0; top: 0; bottom: 0;
      background: rgba(0,0,0,0.78);
      color: #fff;
      font-size: 2.3em;
      font-weight: 900;
      z-index: 99;
      text-align: center;
      line-height: 100vh;
      letter-spacing: 0.08em;
    }
    #footer {
      position: fixed;
      bottom: 0;
      width: 100vw;
      height: 70px;
      background: #007b43;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 12;
      box-shadow: 0 -4px 14px -7px rgba(0,0,0,0.24);
    }
    #camera-label {
      color: white;
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 4px;
      margin-top: 6px;
      letter-spacing: 0.04em;
    }
    #camera-select {
      font-size: 1.25em;
      padding: 8px 18px;
      border-radius: 11px;
      background: #fff;
      color: #007b43;
      border: none;
      font-weight: bold;
      margin-bottom: 10px;
      margin-top: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    @media (min-width: 600px) {
      #reader {
        width: 600px;
        margin: 0 auto;
        left: 0; right: 0;
        top: 0; bottom: 0;
      }
      .qr-custom-overlay {
        width: 360px;
        height: 360px;
      }
      #footer {
        width: 600px;
        left: 50%;
        transform: translateX(-50%);
      }
    }
  </style>
</head>
<body>
  <div id="header">
    <div>CROSTAFF</div>
    <div>v1.0</div>
  </div>
  <div id="info">
    <span id="area-name">エリア名取得中...</span>
    <span id="status">カメラ準備中</span>
  </div>
  <div id="reader-container">
    <div id="reader"></div>
    <div class="qr-custom-overlay"></div>
    <div id="result-banner"></div>
    <div id="processing-banner">処理中...</div>
  </div>
  <div id="footer">
    <div id="camera-label">カメラ切替</div>
    <select id="camera-select"></select>
  </div>
  <script>
    // --- 初期設定・エリア名 ---
    const areaMap = {
      "バックステージ": "obs",
      "小講堂": "osa",
      "男子更衣室": "mcr",
      "女子更衣室": "wcr"
    };
    const reverseAreaMap = {
      "obs": "バックステージ",
      "osa": "小講堂",
      "mcr": "男子更衣室",
      "wcr": "女子更衣室",
      "unk": "未設定"
    };

    const params = new URLSearchParams(location.search);
    const areaName = params.get("area") || "未設定";
    const areaCode = areaMap[areaName] || "unk";
    // 必要に応じてデプロイID修正！
    const endpoint = "https://script.google.com/macros/s/AKfycbx0v1nlONAziZzoQratUpF98n_I8l7sjkn2kWOZs3iJdz2doO9WFv7ILmKBKumO0S2SKw/exec";

    const areaEl = document.getElementById("area-name");
    const statusEl = document.getElementById("status");
    const bannerEl = document.getElementById("result-banner");
    const cameraSelect = document.getElementById("camera-select");
    const processingBanner = document.getElementById("processing-banner");

    areaEl.textContent = areaName;

    let html5QrCode = new Html5Qrcode("reader");
    let currentCameraId = null;
    let scanning = false;
    let lastScan = "";
    let lastTime = 0;

    function updateStatus(message) {
      statusEl.textContent = message;
    }

    function showBanner(message, color, duration = 3000, callback) {
      bannerEl.innerText = message;
      bannerEl.style.display = "block";
      bannerEl.style.backgroundColor = color || "rgba(0,0,0,0.85)";
      setTimeout(() => {
        bannerEl.style.display = "none";
        if (callback) callback();
      }, duration);
    }

    function sendLog(staffId) {
      // --- 処理中バナーを表示 ---
      processingBanner.style.display = "block";
      updateStatus("処理中");
      scanning = false;

      const url = `${endpoint}?staff=${staffId}&area=${areaCode}`;
      fetch(url)
        .then(r => r.text())
        .then(result => {
          // --- バナーを隠す ---
          processingBanner.style.display = "none";
          let [code, area, id] = result.trim().split(",");
          let areaFull = reverseAreaMap[area] || "未設定";
          let actionLabel = "";
          let bannerColor = "";

          if (code === "1") {
            actionLabel = "入室";
            bannerColor = "#34c759";
          } else if (code === "2") {
            actionLabel = "退室";
            bannerColor = "#2196f3";
          } else {
            actionLabel = "記録失敗";
            bannerColor = "#e53935";
          }

          let msg;
          if (actionLabel === "入室" || actionLabel === "退室") {
            msg = `記録成功\n${actionLabel}\n${id}\n${areaFull}`;
          } else {
            msg = `記録失敗\n${id}\n${areaFull}`;
          }
          showBanner(msg, bannerColor, 3000, () => {
            updateStatus("スキャン中");
            scanning = true;
          });
        })
        .catch(() => {
          processingBanner.style.display = "none";
          showBanner("記録失敗\n通信エラー", "#e53935", 3000, () => {
            updateStatus("スキャン中");
            scanning = true;
          });
        });
    }

    function startCamera(cameraId) {
      scanning = true;
      updateStatus("スキャン中");
      html5QrCode.start(
        cameraId,
        {
          fps: 10,
          qrbox: function(w, h) {
            // 中央より少し上に正方形
            const boxSize = Math.min(w, h, 360);
            return {
              width: boxSize,
              height: boxSize,
              x: (w - boxSize) / 2,
              y: Math.max((h * 0.32) - (boxSize / 2), 0)
            };
          },
          aspectRatio: 1.0,
          experimentalFeatures: { useBarCodeDetectorIfSupported: true }
        },
        decodedText => {
          if (!scanning) return;
          if (!decodedText.startsWith("cs25-")) {
            updateStatus("無効なコード");
            return;
          }
          const staffId = decodedText.slice(5);
          const now = Date.now();
          if (staffId === lastScan && now - lastTime < 2500) return; // 2.5秒ダブルスキャンガード
          lastScan = staffId;
          lastTime = now;
          scanning = false;
          sendLog(staffId);
        },
        () => updateStatus("スキャン中")
      ).catch(err => updateStatus("カメラ起動失敗: " + err));
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices.length === 0) {
        updateStatus("カメラが見つかりません");
        return;
      }
      devices.forEach((device, idx) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `カメラ ${idx+1}`;
        cameraSelect.appendChild(option);
      });
      const defaultCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
      currentCameraId = defaultCamera.id;
      cameraSelect.value = currentCameraId;
      startCamera(currentCameraId);

      cameraSelect.addEventListener("change", e => {
        const newCameraId = e.target.value;
        html5QrCode.stop().then(() => startCamera(newCameraId));
      });
    }).catch(err => updateStatus("カメラ取得失敗: " + err));
  </script>
</body>
</html>
