<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QRã‚¹ã‚­ãƒ£ãƒ³ - CROSTAFF</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    #reader { width: 90%; max-width: 500px; margin: auto; }
    #result { margin-top: 20px; font-weight: bold; white-space: pre-wrap; text-align: left; }
    #camera-select { margin-top: 10px; }
    #version { margin-top: 40px; font-size: 0.9em; color: gray; }
    #location-indicator { font-size: 1.2em; margin: 10px 0; color: #444; }
    #status-indicator { font-size: 1.3em; margin-top: 10px; color: #222; }
  </style>
</head>
<body>
  <h2>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</h2>
  <div id="location-indicator">ğŸ“ æ‹…å½“ã‚¨ãƒªã‚¢: èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="status-indicator">ğŸ“„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æœªã‚¹ã‚­ãƒ£ãƒ³</div>
  <div>
    <select id="camera-select"></select>
  </div>
  <div id="reader"></div>
  <div id="result">ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­...</div>
  <div id="version">CROSTAFF Scanner v1.0.3</div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const area = params.get("area") || "æœªè¨­å®š";
    const actionParam = params.get("action");
    const resultDiv = document.getElementById("result");
    const cameraSelect = document.getElementById("camera-select");
    const locationIndicator = document.getElementById("location-indicator");
    const statusIndicator = document.getElementById("status-indicator");

    locationIndicator.innerText = `ğŸ“ æ‹…å½“ã‚¨ãƒªã‚¢: ${area}`;

    let html5QrCode = new Html5Qrcode("reader");
    let currentCameraId = null;

    Html5Qrcode.getCameras().then(devices => {
      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `ã‚«ãƒ¡ãƒ© ${index + 1}`;
        cameraSelect.appendChild(option);
      });

      const defaultCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
      currentCameraId = defaultCamera.id;
      startCamera(currentCameraId);
      cameraSelect.value = currentCameraId;

      cameraSelect.addEventListener("change", (event) => {
        const newCameraId = event.target.value;
        html5QrCode.stop().then(() => {
          startCamera(newCameraId);
        });
      });
    }).catch(err => {
      resultDiv.innerText = `âŒ ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼: ${err}`;
    });

    function startCamera(cameraId) {
      currentCameraId = cameraId;
      resultDiv.innerText = `ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­ï¼ˆID: ${cameraId}ï¼‰`;
      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 350, height: 350 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        resultDiv.innerText = `âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${err}`;
      });
    }

    function restartCameraAfterDelay(delayMs = 3000) {
      setTimeout(() => {
        html5QrCode.start(
          currentCameraId,
          { fps: 10, qrbox: { width: 350, height: 350 } },
          onScanSuccess,
          onScanFailure
        ).then(() => {
          resultDiv.innerText += "\nğŸ“· ã‚«ãƒ¡ãƒ©å†èµ·å‹•å®Œäº†";
        }).catch(err => {
          resultDiv.innerText += `\nâŒ ã‚«ãƒ¡ãƒ©å†èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${err}`;
        });
      }, delayMs);
    }

    function onScanSuccess(decodedText) {
      resultDiv.innerText = `ğŸ” QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚ŠæˆåŠŸ: ${decodedText}\n`;
      statusIndicator.innerText = "ğŸ“„ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: é€ä¿¡ä¸­...";

      if (!decodedText.startsWith("staff=")) {
        resultDiv.innerText += "âŒ ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰å½¢å¼ï¼ˆ'staff='ã§å§‹ã¾ã£ã¦ã„ã¾ã›ã‚“ï¼‰";
        statusIndicator.innerText = "âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰";
        return;
      }

      html5QrCode.stop().then(() => {
        resultDiv.innerText += "ğŸ›‘ ã‚«ãƒ¡ãƒ©åœæ­¢ä¸­ï¼ˆé€ä¿¡å‡¦ç†ã®ãŸã‚ï¼‰\n";

        const endpoint = "https://script.google.com/macros/s/AKfycbx85vMW0Rh9zTRqnLfyr4zAjZ-WWVIIB-8CBC46elZfe_cJyCbewoQfRuf0n5nWj5r1/exec";
        const staffParam = decodedText;
        const areaParam = encodeURIComponent(area);
        const actionFinal = actionParam ? `&action=${encodeURIComponent(actionParam)}` : "";
        const url = `${endpoint}?${staffParam}&area=${areaParam}${actionFinal}`;

        resultDiv.innerText += `ğŸŒ URLç”Ÿæˆå®Œäº†: ${url}\n`;
        resultDiv.innerText += `ğŸ“¦ é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª â†’ staff=${staffParam}, area=${areaParam}, action=${actionParam || "ãƒˆã‚°ãƒ«"}\n`;

        fetch(url)
          .then(res => {
            resultDiv.innerText += `ğŸŒ ã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status} (${res.statusText})\n`;
            return res.text();
          })
          .then(txt => {
            resultDiv.innerText += `âœ… è¨˜éŒ²æˆåŠŸ: ${txt}`;

            const match = txt.match(/(IN|OUT)/);
            if (match) {
              statusIndicator.innerText = `âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${match[1]}`;
            } else {
              statusIndicator.innerText = "âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: è¨˜éŒ²æ¸ˆï¼ˆçŠ¶æ…‹ä¸æ˜ï¼‰";
            }
            restartCameraAfterDelay();
          })
          .catch(err => {
            resultDiv.innerText += `âŒ fetché€šä¿¡ã‚¨ãƒ©ãƒ¼: ${err}`;
            statusIndicator.innerText = `âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: é€šä¿¡ã‚¨ãƒ©ãƒ¼`;
            restartCameraAfterDelay();
          });
      }).catch(stopErr => {
        resultDiv.innerText += `âŒ ã‚«ãƒ¡ãƒ©åœæ­¢æ™‚ã‚¨ãƒ©ãƒ¼: ${stopErr}`;
        statusIndicator.innerText = `âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚«ãƒ¡ãƒ©åœæ­¢å¤±æ•—`;
      });
    }

    function onScanFailure(error) {
      // èª­ã¿å–ã‚Šå¤±æ•—æ™‚ã®ãƒ­ã‚°ï¼ˆè©³ç´°ã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    }
  </script>
</body>
</html>
